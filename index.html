<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>text-joiner</title>

    <style>
        *, *::before, *::after{
            box-sizing: border-box;
        }
        body, html{
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body{
            padding: 1rem;
        }
        table{
            border-collapse: collapse;
        }
        table th,
        table td{
            border: 1px solid #7f7f7f;
            padding: 4px;
        }
        .idx{
            margin: 0 3px;
        }
    </style>
</head>

<body>
    <h1>text-joiner</h1>

    <input id="file-1" type="file" multiple>

    <div style="margin-top: 1rem; border-bottom: 1px solid;"></div>

    <table style="margin-top: 1rem; font-size: 0.8rem;">
        <thead>
            <tr>
                <th>No</th>
                <th>Filename</th>
                <th>Mimetype</th>
                <th>Size</th>
            </tr>
        </thead>
        <tbody id="result-1"></tbody>
        <tbody>
            <tr>
                <td colspan="100%" style="text-align: center;">
                    <button type="button" onclick="downloadEvt()">Download</button>
                </td>
            </tr>
        </tbody>
    </table>

    <div style="margin-top: 1rem; border-bottom: 1px solid;"></div>

    <div>
        <h4>Result</h4>
        <textarea id="result-2" style="width: 100%; min-height: 256px;" readonly></textarea>
    </div>

    <script src="dist/text-joiner.js"></script>
    <script src="utils/text-comparer.js"></script>
    <script>
        var _files = [];

        function chooseEvt(e) {
            _files = [];
            var files = document.getElementById("file-1").files;

            
            for (var i = 0; i < files.length; i++) {
                _files.push(files[i]);
            }

            _files.sort(function(a, b) {
                return textComparer.compare(a.name, b.name);
            });
           
            listEvt(_files);
            joinEvt(_files);
        }

        function idxUp(i) {
            if (typeof(_files[i+1]) == "undefined") {
                return false;
            }
            var element = _files.splice(i, 1)[0];
            _files.splice(i+1, 0, element);

            listEvt(_files);
            joinEvt(_files);
        }

        function idxDown(i) {
            if (typeof(_files[i-1]) == "undefined") {
                return false;
            }
            var element = _files.splice(i, 1)[0];
            _files.splice(i-1, 0, element);

            listEvt(_files);
            joinEvt(_files);
        }

        function listEvt(arr) {
            var tbody = document.getElementById("result-1");
            tbody.innerHTML = "";
            for (var i = 0; i < arr.length; i++) {
                var f = arr[i];
                var filename = f.name;
                var mimeType = f.type;
                var fileSize = f.size;

                var row = "";
                row += "<tr>";
                row += "<td>";
                if (i == 0) {
                    row += "<button type='button' disabled>-</button>";
                } else {
                    row += "<button type='button' onclick='idxDown("+i+")'>-</button>";
                }
                row += "<span class='idx'>"+(i+1)+"</span>";
                if (i == arr.length-1) {
                    row += "<button type='button' disabled>+</button>";
                } else {
                    row += "<button type='button' onclick='idxUp("+i+")'>+</button>";
                }
                row += "</td>";
                row += "<td>"+filename+"</td>";
                row += "<td>"+mimeType+"</td>";
                row += "<td>"+fileSize+" bytes</td>";
                row += "</tr>";

                tbody.innerHTML += row;
            }
        }

        function joinEvt(arr) {
            document.getElementById("result-2").value = "";
            textJoiner.join(arr, null, function(err, res) {
                if (err) {
                    console.error(err);
                    return false;
                }
                document.getElementById("result-2").value = res;
            });
        }

        function downloadEvt() {
            textJoiner.join(_files, null, function(err, res) {
                if (err) {
                    console.error(err);
                    return false;
                }
                var blob = new Blob([res], { type: 'text/plain' });
                var elem = window.document.createElement('a');
                var url = window.URL.createObjectURL(blob);
                elem.href = url;
                elem.download = "download";
                elem.style.display = 'none';
                document.body.appendChild(elem);
                elem.click();
                document.body.removeChild(elem);
                window.URL.revokeObjectURL(url);
            });
        }

        document.getElementById("file-1").addEventListener("change", chooseEvt, false);
    </script>
</body>

</html>